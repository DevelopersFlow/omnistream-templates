FROM node:16.15.0 as BUILD_IMAGE

WORKDIR /app

ARG HOST
ARG PORT
ARG NODE_ENV
ARG APP_API_URL
ARG APP_WEB_URL
ARG MAIN_DB_TYPE
ARG MAIN_DB_HOST
ARG MAIN_DB_PORT
ARG MAIN_DB_USER
ARG MAIN_DB_PASS
ARG MAIN_DATABASE
ARG MONGO_DB_TYPE
ARG MONGO_DB_HOST
ARG MONGO_DB_PORT
ARG MONGO_DB_USER
ARG MONGO_DB_PASS
ARG MONGO_DATABASE
ARG REDIS_DB_HOST
ARG REDIS_DB_PORT
ARG REDIS_DB_PASS
ARG ENTITIES_ROOT_PATH
ARG ENTITIES_EXTENSION
ARG JWT_SECRET_TOKEN
ARG JWT_EXPIRES_IN_SECRET_TOKEN
ARG JWT_SECRET_REFRESH_TOKEN
ARG JWT_EXPIRES_IN_REFRESH_TOKEN
ARG STORAGE_DRIVERdisk
ARG STORAGE_BUCKET
ARG STORAGE_BUCKET_URL
ARG MAIL_DRIVERethereal
ARG AWS_ACCESS_KEY_ID
ARG AWS_SECRET_ACCESS_KEY
ARG AWS_DEFAULT_REGION
ARG SENTRY_DSN
ARG POPULATE_DEV_SEEDS

ENV HOST=${HOST}
ENV PORT=${PORT}
ENV NODE_ENV=${NODE_ENV}
ENV APP_API_URL=${APP_API_URL}
ENV APP_WEB_URL=${APP_WEB_URL}
ENV MAIN_DB_TYPE=${MAIN_DB_TYPE}
ENV MAIN_DB_HOST=${MAIN_DB_HOST}
ENV MAIN_DB_PORT=${MAIN_DB_PORT}
ENV MAIN_DB_USER=${MAIN_DB_USER}
ENV MAIN_DB_PASS=${MAIN_DB_PASS}
ENV MAIN_DATABASE=${MAIN_DATABASE}
ENV MONGO_DB_TYPE=${MONGO_DB_TYPE}
ENV MONGO_DB_HOST=${MONGO_DB_HOST}
ENV MONGO_DB_PORT=${MONGO_DB_PORT}
ENV MONGO_DB_USER=${MONGO_DB_USER}
ENV MONGO_DB_PASS=${MONGO_DB_PASS}
ENV MONGO_DATABASE=${MONGO_DATABASE}
ENV REDIS_DB_HOST=${REDIS_DB_HOST}
ENV REDIS_DB_PORT=${REDIS_DB_PORT}
ENV REDIS_DB_PASS=${REDIS_DB_PASS}
ENV ENTITIES_ROOT_PATH=${ENTITIES_ROOT_PATH}
ENV ENTITIES_EXTENSION=${ENTITIES_EXTENSION}
ENV JWT_SECRET_TOKEN=${JWT_SECRET_TOKEN}
ENV JWT_EXPIRES_IN_SECRET_TOKEN=${JWT_EXPIRES_IN_SECRET_TOKEN}
ENV JWT_SECRET_REFRESH_TOKEN=${JWT_SECRET_REFRESH_TOKEN}
ENV JWT_EXPIRES_IN_REFRESH_TOKEN=${JWT_EXPIRES_IN_REFRESH_TOKEN}
ENV STORAGE_DRIVERdisk=${STORAGE_DRIVERdisk}
ENV STORAGE_BUCKET=${STORAGE_BUCKET}
ENV STORAGE_BUCKET_URL=${STORAGE_BUCKET_URL}
ENV MAIL_DRIVERethereal=${MAIL_DRIVERethereal}
ENV AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
ENV AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
ENV AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION}
ENV SENTRY_DSN=${SENTRY_DSN}
ENV POPULATE_DEV_SEEDS=${POPULATE_DEV_SEEDS}

COPY package.json yarn.lock ./

RUN yarn install --frozen-lockfile --production=false

COPY . .

RUN yarn build

RUN npm prune --omit=dev

FROM node:16.15.0

WORKDIR /app

ARG HOST
ARG PORT
ARG NODE_ENV
ARG APP_API_URL
ARG APP_WEB_URL
ARG MAIN_DB_TYPE
ARG MAIN_DB_HOST
ARG MAIN_DB_PORT
ARG MAIN_DB_USER
ARG MAIN_DB_PASS
ARG MAIN_DATABASE
ARG MONGO_DB_TYPE
ARG MONGO_DB_HOST
ARG MONGO_DB_PORT
ARG MONGO_DB_USER
ARG MONGO_DB_PASS
ARG MONGO_DATABASE
ARG REDIS_DB_HOST
ARG REDIS_DB_PORT
ARG REDIS_DB_PASS
ARG ENTITIES_ROOT_PATH
ARG ENTITIES_EXTENSION
ARG JWT_SECRET_TOKEN
ARG JWT_EXPIRES_IN_SECRET_TOKEN
ARG JWT_SECRET_REFRESH_TOKEN
ARG JWT_EXPIRES_IN_REFRESH_TOKEN
ARG STORAGE_DRIVERdisk
ARG STORAGE_BUCKET
ARG STORAGE_BUCKET_URL
ARG MAIL_DRIVERethereal
ARG AWS_ACCESS_KEY_ID
ARG AWS_SECRET_ACCESS_KEY
ARG AWS_DEFAULT_REGION
ARG SENTRY_DSN
ARG POPULATE_DEV_SEEDS

ENV HOST=${HOST}
ENV PORT=${PORT}
ENV NODE_ENV=${NODE_ENV}
ENV APP_API_URL=${APP_API_URL}
ENV APP_WEB_URL=${APP_WEB_URL}
ENV MAIN_DB_TYPE=${MAIN_DB_TYPE}
ENV MAIN_DB_HOST=${MAIN_DB_HOST}
ENV MAIN_DB_PORT=${MAIN_DB_PORT}
ENV MAIN_DB_USER=${MAIN_DB_USER}
ENV MAIN_DB_PASS=${MAIN_DB_PASS}
ENV MAIN_DATABASE=${MAIN_DATABASE}
ENV MONGO_DB_TYPE=${MONGO_DB_TYPE}
ENV MONGO_DB_HOST=${MONGO_DB_HOST}
ENV MONGO_DB_PORT=${MONGO_DB_PORT}
ENV MONGO_DB_USER=${MONGO_DB_USER}
ENV MONGO_DB_PASS=${MONGO_DB_PASS}
ENV MONGO_DATABASE=${MONGO_DATABASE}
ENV REDIS_DB_HOST=${REDIS_DB_HOST}
ENV REDIS_DB_PORT=${REDIS_DB_PORT}
ENV REDIS_DB_PASS=${REDIS_DB_PASS}
ENV ENTITIES_ROOT_PATH=${ENTITIES_ROOT_PATH}
ENV ENTITIES_EXTENSION=${ENTITIES_EXTENSION}
ENV JWT_SECRET_TOKEN=${JWT_SECRET_TOKEN}
ENV JWT_EXPIRES_IN_SECRET_TOKEN=${JWT_EXPIRES_IN_SECRET_TOKEN}
ENV JWT_SECRET_REFRESH_TOKEN=${JWT_SECRET_REFRESH_TOKEN}
ENV JWT_EXPIRES_IN_REFRESH_TOKEN=${JWT_EXPIRES_IN_REFRESH_TOKEN}
ENV STORAGE_DRIVERdisk=${STORAGE_DRIVERdisk}
ENV STORAGE_BUCKET=${STORAGE_BUCKET}
ENV STORAGE_BUCKET_URL=${STORAGE_BUCKET_URL}
ENV MAIL_DRIVERethereal=${MAIL_DRIVERethereal}
ENV AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
ENV AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
ENV AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION}
ENV SENTRY_DSN=${SENTRY_DSN}
ENV POPULATE_DEV_SEEDS=${POPULATE_DEV_SEEDS}

COPY --from=BUILD_IMAGE /app/package.json ./package.json
COPY --from=BUILD_IMAGE /app/node_modules ./node_modules
COPY --from=BUILD_IMAGE /app/dist ./dist
COPY --from=BUILD_IMAGE /app/ormconfig.ts ./ormconfig.ts

EXPOSE ${PORT}

CMD ["yarn", "start"]
